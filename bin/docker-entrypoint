#!/bin/bash
set -ex  # -e exits on error, -x prints each command

>&2 echo "=== ENTRYPOINT START ==="
>&2 echo "Args: $@"
>&2 echo "PORT: ${PORT:-not set}"
>&2 echo "PWD: $(pwd)"

# If running the rails server then create or migrate existing database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  >&2 echo "✓ Matched rails server command"
  >&2 echo "→ Running db:prepare..."

  ./bin/rails db:prepare

  >&2 echo "✓ db:prepare completed"
  >&2 echo "=== STARTING RAILS SERVER ==="

  # Use PORT from environment (Railway provides this)
  RAILS_PORT=${PORT:-3000}
  >&2 echo "→ Port: ${RAILS_PORT}"
  >&2 echo "→ Command: ./bin/rails server -b 0.0.0.0 -p ${RAILS_PORT}"

  exec ./bin/rails server -b 0.0.0.0 -p "${RAILS_PORT}"
else
  >&2 echo "✗ No match, executing: $@"
  exec "$@"
fi
