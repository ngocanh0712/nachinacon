<style>
  .form-input-accent:focus { border-color: #C0DFD0 !important; box-shadow: 0 0 0 4px rgba(192,223,208,0.2) !important; outline: none; }
  .form-input-accent:hover { border-color: #C0DFD0; }
  .upload-zone-accent:hover { border-color: #C0DFD0 !important; background-color: rgba(192,223,208,0.05) !important; }
</style>

<%= form_with model: [:admin, @album], class: "space-y-6" do |f| %>
  <!-- Error messages -->
  <% if @album.errors.any? %>
    <div class="p-4 rounded-xl border-2" style="background-color: #FEF2F2; border-color: #FECACA;">
      <div class="flex items-start gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-red-500 mt-0.5 flex-shrink-0">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
        </svg>
        <div>
          <p class="font-heading font-semibold text-red-700">Có <%= @album.errors.count %> lỗi xảy ra:</p>
          <ul class="list-disc list-inside text-sm text-red-600 mt-2 space-y-1">
            <% @album.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Name -->
  <div>
    <label for="album_name" class="flex items-center gap-1 text-sm font-semibold text-gray-700 mb-2 font-heading">
      Tên album
      <span class="text-red-500">*</span>
    </label>
    <%= f.text_field :name,
      class: "form-input-accent w-full px-4 py-3 rounded-xl border-2 border-gray-200 transition-all duration-200 font-body placeholder-gray-400",
      placeholder: "Ví dụ: Sinh nhật 1 tuổi" %>
  </div>

  <!-- Description -->
  <div>
    <label for="album_description" class="block text-sm font-semibold text-gray-700 mb-2 font-heading">Mô tả</label>
    <%= f.text_area :description,
      rows: 3,
      class: "form-input-accent w-full px-4 py-3 rounded-xl border-2 border-gray-200 transition-all duration-200 font-body placeholder-gray-400 resize-none",
      placeholder: "Mô tả ngắn về album..." %>
  </div>

  <!-- Cover Photo -->
  <div>
    <label class="block text-sm font-semibold text-gray-700 mb-2 font-heading">Ảnh bìa</label>

    <!-- Preview existing image -->
    <% if @album.cover_image_path.present? || @album.cover_photo.attached? %>
      <div class="mb-4 p-4 rounded-xl bg-gray-50 border-2 border-gray-200">
        <div class="flex items-center gap-4">
          <% if @album.cover_image_path.present? %>
            <%= image_tag @album.cover_image_path, class: "w-20 h-20 rounded-lg object-cover" %>
          <% elsif @album.cover_photo.attached? %>
            <%= image_tag @album.cover_photo.variant(resize_to_fill: [80, 80]), class: "w-20 h-20 rounded-lg object-cover" %>
          <% end %>
          <div class="flex-1 min-w-0">
            <p class="font-heading font-medium text-gray-800 truncate">
              <%= @album.cover_image_path.present? ? File.basename(@album.cover_image_path) : @album.cover_photo.filename %>
            </p>
            <p class="text-sm text-gray-500 font-body">
              <%= @album.cover_photo.attached? ? number_to_human_size(@album.cover_photo.byte_size) : 'Ảnh đã lưu' %>
            </p>
          </div>
          <div class="px-3 py-1 rounded-full text-xs font-body" style="background-color: #C0DFD0; color: #333;">
            Đã tải lên
          </div>
        </div>
      </div>
    <% end %>

    <!-- Image preview container (for new upload) -->
    <div id="albumImagePreview" class="hidden mb-4 p-4 rounded-xl bg-gray-50 border-2 border-gray-200">
      <div class="flex items-center gap-4">
        <img id="albumPreviewImg" src="" alt="Preview" class="w-20 h-20 rounded-lg object-cover">
        <div class="flex-1 min-w-0">
          <p id="albumFileName" class="font-heading font-medium text-gray-800 truncate"></p>
          <p id="albumFileSize" class="text-sm text-gray-500 font-body"></p>
        </div>
        <button type="button" onclick="clearAlbumPreview()" class="px-3 py-1 rounded-full text-xs font-body hover:bg-red-100 transition-colors" style="background-color: #FEE2E2; color: #DC2626;">
          Xóa
        </button>
      </div>
    </div>

    <div class="relative">
      <%= f.file_field :cover_photo,
        accept: "image/jpeg,image/jpg,image/png,image/webp",
        class: "sr-only",
        id: "album_cover_photo_input",
        onchange: "previewAlbumImage(this)" %>

      <label for="album_cover_photo_input"
        class="upload-zone-accent flex flex-col items-center justify-center p-8 rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 cursor-pointer transition-all duration-200">
        <div class="w-14 h-14 rounded-full flex items-center justify-center mb-3" style="background-color: rgba(192,223,208,0.3);">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7" style="color: #A8D1BD;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
          </svg>
        </div>
        <p class="font-heading font-semibold text-gray-700">Kéo thả hoặc nhấp để chọn ảnh bìa</p>
        <p class="text-sm text-gray-500 mt-1 font-body">JPG, PNG, WEBP • Tối đa 10MB</p>
      </label>
    </div>
  </div>

  <script>
    function previewAlbumImage(input) {
      const file = input.files[0];
      if (!file) return;

      if (!file.type.match('image/jpeg') && !file.type.match('image/jpg') && !file.type.match('image/png') && !file.type.match('image/webp')) {
        alert('Chỉ chấp nhận file ảnh (JPG, PNG, WEBP)');
        input.value = '';
        return;
      }

      if (file.size > 10 * 1024 * 1024) {
        alert('File ảnh quá lớn. Vui lòng chọn ảnh nhỏ hơn 10MB');
        input.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('albumPreviewImg').src = e.target.result;
        document.getElementById('albumFileName').textContent = file.name;
        document.getElementById('albumFileSize').textContent = formatAlbumFileSize(file.size);
        document.getElementById('albumImagePreview').classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }

    function clearAlbumPreview() {
      document.getElementById('album_cover_photo_input').value = '';
      document.getElementById('albumImagePreview').classList.add('hidden');
      document.getElementById('albumPreviewImg').src = '';
    }

    function formatAlbumFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
  </script>

  <!-- Buttons -->
  <div class="flex items-center gap-4 pt-4">
    <%= f.submit @album.persisted? ? "Cập nhật" : "Tạo album",
      class: "px-6 py-3 rounded-xl font-heading font-semibold text-gray-800 cursor-pointer shadow-md hover:shadow-lg transition-all duration-200",
      style: "background: linear-gradient(135deg, #C0DFD0 0%, #A8D1BD 100%);" %>
    <%= link_to "Hủy", admin_albums_path,
      class: "px-6 py-3 rounded-xl font-heading font-semibold text-gray-600 hover:text-gray-800 hover:bg-gray-100 transition-colors" %>
  </div>
<% end %>
