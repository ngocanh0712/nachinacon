<!-- Memory Detail Modal -->
<div id="memoryModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
  <!-- Backdrop -->
  <div id="modalBackdrop" class="fixed inset-0 bg-black/60 transition-opacity duration-200 opacity-0" onclick="closeMemoryModal()"></div>

  <!-- Modal Container -->
  <div class="flex min-h-screen items-center justify-center p-4">
    <div class="relative w-full max-w-4xl transition-all duration-200 scale-95 opacity-0" id="modalContent">
      <!-- Close Button -->
      <button onclick="closeMemoryModal()" class="absolute -top-4 -right-4 z-10 w-12 h-12 rounded-full flex items-center justify-center shadow-2xl transition-all duration-300 hover:scale-110 hover:rotate-90" style="background: linear-gradient(135deg, #F2C2C2, #E8B0B0);">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6 text-white">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- Modal Content -->
      <div class="bg-white rounded-3xl overflow-hidden shadow-xl">
        <div class="grid md:grid-cols-2 gap-0">
          <!-- Image Section -->
          <div class="relative bg-gray-100 md:min-h-[600px]">
            <div class="absolute inset-0 flex items-center justify-center p-8">
              <div class="relative w-full h-full">
                <img id="modalImage" src="" alt="" class="w-full h-full object-contain rounded-2xl shadow-xl" />
                <!-- Image placeholder -->
                <div id="modalImagePlaceholder" class="hidden absolute inset-0 flex items-center justify-center" style="background: linear-gradient(135deg, #FCE7F3, #DBEAFE);">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="w-24 h-24 text-gray-300">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Content Section -->
          <div class="p-8 md:p-10 flex flex-col bg-white">
            <!-- Age Badge -->
            <div class="mb-6">
              <div id="modalAgeBadge" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-heading font-bold shadow-lg"></div>
            </div>

            <!-- Title -->
            <h2 id="modalTitle" class="font-accent italic text-3xl md:text-4xl mb-4 leading-tight" style="color: #2D3748;"></h2>

            <!-- Date -->
            <div class="flex items-center gap-3 mb-6">
              <div class="w-10 h-10 rounded-xl flex items-center justify-center shadow-md" style="background: linear-gradient(135deg, #C1DDD8, #A8CEC8);">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-white">
                  <path fill-rule="evenodd" d="M6.75 2.25A.75.75 0 017.5 3v1.5h9V3A.75.75 0 0118 3v1.5h.75a3 3 0 013 3v11.25a3 3 0 01-3 3H5.25a3 3 0 01-3-3V7.5a3 3 0 013-3H6V3a.75.75 0 01.75-.75zm13.5 9a1.5 1.5 0 00-1.5-1.5H5.25a1.5 1.5 0 00-1.5 1.5v7.5a1.5 1.5 0 001.5 1.5h13.5a1.5 1.5 0 001.5-1.5v-7.5z" clip-rule="evenodd" />
                </svg>
              </div>
              <div>
                <p class="font-body text-xs text-gray-500">Ngày ghi nhận</p>
                <p id="modalDate" class="font-heading font-bold text-base text-gray-700"></p>
              </div>
            </div>

            <!-- Decorative divider -->
            <div class="flex items-center gap-3 my-6">
              <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-200 to-transparent"></div>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5" style="color: #F2C2C2;">
                <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" />
              </svg>
              <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-200 to-transparent"></div>
            </div>

            <!-- Caption -->
            <div class="flex-1 overflow-y-auto max-h-[300px] pr-2 custom-scrollbar">
              <p id="modalCaption" class="font-body text-base text-gray-600 leading-relaxed whitespace-pre-line"></p>
            </div>

            <!-- Reactions -->
            <div id="modalReactions" style="margin-top:24px;padding-top:20px;border-top:1px solid #F3F4F6;">
              <div data-controller="reactions" data-reactions-memory-id-value="" id="modalReactionsContainer" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                <% Reaction::EMOJIS.each do |emoji| %>
                  <button data-reactions-target="btn"
                          data-action="click->reactions#react"
                          data-emoji="<%= emoji %>"
                          class="reaction-btn"
                          style="display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border-radius:20px;border:2px solid #F3F4F6;background:white;cursor:pointer;font-size:18px;transition:all 0.2s ease;position:relative;">
                    <span><%= emoji %></span>
                    <span data-reactions-target="count" style="font-size:12px;font-weight:600;color:#6B7280;display:none;">0</span>
                  </button>
                <% end %>
              </div>
            </div>

            <!-- Share buttons -->
            <div id="modalShareButtons" style="margin-top:16px;padding-top:16px;border-top:1px solid #F3F4F6;">
              <div data-controller="share" data-share-url-value="" data-share-title-value="" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                <span class="font-body" style="font-size:14px;color:#9CA3AF;margin-right:4px;">Chia se:</span>

                <!-- Native Share (mobile) -->
                <button data-action="click->share#nativeShare" data-share-target="nativeBtn"
                  style="display:none;width:44px;height:44px;border-radius:12px;border:none;cursor:pointer;background:linear-gradient(135deg,#C1DDD8,#A8CEC8);align-items:center;justify-content:center;" title="Chia se">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:24px;height:24px;color:white;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z" />
                  </svg>
                </button>

                <!-- Facebook -->
                <a id="modalShareFacebook" href="#" target="_blank" rel="noopener"
                  style="display:flex;width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#1877F2,#0C63D4);align-items:center;justify-content:center;text-decoration:none;" title="Facebook">
                  <svg style="width:24px;height:24px;color:white;" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                </a>

                <!-- Zalo -->
                <a id="modalShareZalo" href="#" target="_blank" rel="noopener"
                  style="display:block;width:44px;height:44px;border-radius:12px;overflow:hidden;text-decoration:none;" title="Zalo">
                  <%= image_tag 'zalo-icon.png', alt: 'Zalo', style: 'width:44px;height:44px;display:block;border-radius:12px;' %>
                </a>

                <!-- WhatsApp -->
                <a id="modalShareWhatsApp" href="#" target="_blank" rel="noopener"
                  style="display:flex;width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#25D366,#128C7E);align-items:center;justify-content:center;text-decoration:none;" title="WhatsApp">
                  <svg style="width:24px;height:24px;color:white;" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                </a>

                <!-- Copy Link -->
                <button data-action="click->share#copyLink" data-share-target="copyBtn"
                  style="position:relative;display:flex;width:44px;height:44px;border-radius:12px;border:none;cursor:pointer;background:linear-gradient(135deg,#E0EEEB,#C1DDD8);align-items:center;justify-content:center;" title="Sao chep link">
                  <svg data-share-target="copyIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:24px;height:24px;color:#4B5563;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                  </svg>
                  <svg data-share-target="checkIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:24px;height:24px;color:#16A34A;display:none;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                  </svg>
                  <span data-share-target="tooltip" style="position:absolute;top:-32px;left:50%;transform:translateX(-50%);padding:4px 8px;border-radius:8px;font-size:12px;color:white;white-space:nowrap;opacity:0;transition:opacity 0.2s;pointer-events:none;background:#333;">
                    Da sao chep!
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function openMemoryModal(data) {
    // Get elements directly each time to ensure they exist
    const modal = document.getElementById('memoryModal');
    const modalContent = document.getElementById('modalContent');
    const modalImage = document.getElementById('modalImage');
    const modalImagePlaceholder = document.getElementById('modalImagePlaceholder');
    const modalTitle = document.getElementById('modalTitle');
    const modalDate = document.getElementById('modalDate');
    const modalCaption = document.getElementById('modalCaption');
    const modalAgeBadge = document.getElementById('modalAgeBadge');
    const backdrop = document.getElementById('modalBackdrop');

    // Safety check
    if (!modal || !modalContent) {
      console.error('Modal elements not found');
      return;
    }

    // Set content
    modalTitle.textContent = data.title || '';
    modalDate.textContent = data.date || '';
    modalCaption.textContent = data.caption || '';

    // Set age badge
    const ageBadgeColor = data.ageColor || '#DBEAFE;#3B82F6';
    const [bgColor, textColor] = ageBadgeColor.split(';');
    modalAgeBadge.style.background = bgColor + 'ee';
    modalAgeBadge.style.color = textColor;
    modalAgeBadge.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
        <path d="M12.75 12.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM7.5 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM8.25 17.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM9.75 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM10.5 17.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM12 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM12.75 17.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM14.25 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM15 17.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM16.5 15.75a.75.75 0 100-1.5.75.75 0 000 1.5zM15 12.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM16.5 13.5a.75.75 0 100-1.5.75.75 0 000 1.5z" />
        <path fill-rule="evenodd" d="M6.75 2.25A.75.75 0 017.5 3v1.5h9V3A.75.75 0 0118 3v1.5h.75a3 3 0 013 3v11.25a3 3 0 01-3 3H5.25a3 3 0 01-3-3V7.5a3 3 0 013-3H6V3a.75.75 0 01.75-.75zm13.5 9a1.5 1.5 0 00-1.5-1.5H5.25a1.5 1.5 0 00-1.5 1.5v7.5a1.5 1.5 0 001.5 1.5h13.5a1.5 1.5 0 001.5-1.5v-7.5z" clip-rule="evenodd" />
      </svg>
      <span>${data.ageGroup || ''}</span>
    `;

    // Set image
    if (data.imageUrl) {
      modalImage.src = data.imageUrl;
      modalImage.classList.remove('hidden');
      modalImagePlaceholder.classList.add('hidden');
    } else {
      modalImage.classList.add('hidden');
      modalImagePlaceholder.classList.remove('hidden');
    }

    // Update reactions with memory ID
    if (data.memoryId) {
      const reactionsContainer = document.getElementById('modalReactionsContainer');
      if (reactionsContainer) {
        reactionsContainer.setAttribute('data-reactions-memory-id-value', data.memoryId);
        // Reset reaction counts and states
        reactionsContainer.querySelectorAll('[data-reactions-target="btn"]').forEach(btn => {
          const countEl = btn.querySelector('[data-reactions-target="count"]');
          if (countEl) { countEl.textContent = '0'; countEl.style.display = 'none'; }
          btn.classList.remove('reacted');
          const emoji = btn.dataset.emoji;
          if (localStorage.getItem(`reacted_${data.memoryId}_${emoji}`)) {
            btn.classList.add('reacted');
          }
        });
        // Load existing reaction counts from server
        fetch(`/memories/${data.memoryId}/reactions`, {
          headers: { 'Accept': 'application/json' }
        }).then(r => r.json()).then(json => {
          const reactions = json.reactions || {};
          reactionsContainer.querySelectorAll('[data-reactions-target="btn"]').forEach(btn => {
            const emoji = btn.dataset.emoji;
            const count = reactions[emoji];
            const countEl = btn.querySelector('[data-reactions-target="count"]');
            if (countEl && count && count > 0) {
              countEl.textContent = count;
              countEl.style.display = 'inline';
            }
          });
          // Sync card reactions outside modal with server data
          const cardReactionsEl = document.querySelector(`.card-reactions[data-card-memory-id="${data.memoryId}"]`);
          if (cardReactionsEl) {
            const sorted = Object.entries(reactions).filter(([,c]) => c > 0).sort((a, b) => b[1] - a[1]).slice(0, 3);
            cardReactionsEl.innerHTML = sorted.map(([emoji, count]) =>
              `<span class="inline-flex items-center gap-0.5 text-xs" style="color:#6B7280;">` +
                `<span>${emoji}</span>` +
                `<span class="font-heading font-semibold" style="font-size:10px;">${count}</span>` +
              `</span>`
            ).join('');
          }
        }).catch(() => {});
      }

      const shareUrl = window.location.origin + '/memories/' + data.memoryId;
      const shareTitle = data.title || 'NaChiNaCon';
      const encodedUrl = encodeURIComponent(shareUrl);
      const encodedText = encodeURIComponent(shareTitle + ' ' + shareUrl);

      const shareContainer = document.getElementById('modalShareButtons');
      if (shareContainer) {
        const shareDiv = shareContainer.querySelector('[data-controller="share"]');
        if (shareDiv) {
          shareDiv.setAttribute('data-share-url-value', shareUrl);
          shareDiv.setAttribute('data-share-title-value', shareTitle);
        }
        const fbLink = document.getElementById('modalShareFacebook');
        if (fbLink) fbLink.href = 'https://www.facebook.com/sharer/sharer.php?u=' + encodedUrl;
        const zaloLink = document.getElementById('modalShareZalo');
        if (zaloLink) zaloLink.href = 'https://zalo.me/share?url=' + encodedUrl;
        const waLink = document.getElementById('modalShareWhatsApp');
        if (waLink) waLink.href = 'https://api.whatsapp.com/send?text=' + encodedText;
      }
    }

    // Show modal with animation
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Use requestAnimationFrame for smoother animation
    requestAnimationFrame(() => {
      backdrop.classList.remove('opacity-0');
      backdrop.classList.add('opacity-100');
      modalContent.classList.remove('scale-95', 'opacity-0');
      modalContent.classList.add('scale-100', 'opacity-100');
    });
  }

  // Helper function to read data from element attributes
  function openMemoryModalFromData(element) {
    const data = {
      title: element.dataset.memoryTitle || '',
      date: element.dataset.memoryDate || '',
      caption: element.dataset.memoryCaption || '',
      imageUrl: element.dataset.memoryImage || '',
      ageGroup: element.dataset.memoryAgeGroup || '',
      ageColor: element.dataset.memoryAgeColor || '#DBEAFE;#3B82F6',
      memoryId: element.dataset.memoryId || ''
    };
    openMemoryModal(data);
  }

  function closeMemoryModal() {
    const modal = document.getElementById('memoryModal');
    const modalContent = document.getElementById('modalContent');
    const backdrop = document.getElementById('modalBackdrop');

    if (!modal || !modalContent) return;

    // Animate out
    backdrop.classList.remove('opacity-100');
    backdrop.classList.add('opacity-0');
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');

    setTimeout(() => {
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }, 200);
  }

  // Close modal on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeMemoryModal();
    }
  });
</script>

<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #F2C2C2, #C1DDD8);
    border-radius: 10px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #E8B0B0, #A8CEC8);
  }
</style>
